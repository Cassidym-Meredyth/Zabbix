name: Deploy Zabbix infra

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Destroy old VMs
        run: |
          vagrant destroy -f
          if ($LASTEXITCODE -ne 0) {
            Write-Host "vagrant destroy failed, ignore"
          }

      - name: Vagrant up vm1
        run: |
          $ErrorActionPreference = "Stop"
          vagrant up vm1-test --no-color --provision

      - name: Vagrant up vm2
        run: |
          $ErrorActionPreference = "Stop"
          vagrant up vm2-test --no-color --provision
        
      - name: Vagrant up vm3
        run: |
          $ErrorActionPreference = "Stop"
          vagrant up vm3-test --no-color --provision

      - name: Health check
        run: |
          vagrant ssh vm1-test -c "docker ps"

